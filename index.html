<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Vulcão de Santa Barbara Shake</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#000000" />

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Vulcão de Santa Barbara Shake" />
  <link rel="apple-touch-icon" href="icon-512.png" />

  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111;
      color: #eee;
      overflow: hidden;
    }

    #app {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    #sidebar {
      width: 300px;
      background: #181818;
      border-right: 1px solid #333;
      padding: 10px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    #sidebar h1 {
      font-size: 16px;
      margin: 0 0 10px 0;
      text-align: center;
    }

    #sidebar small {
      display: block;
      margin-bottom: 4px;
      color: #aaa;
      text-align: center;
    }

    #ultima-atualizacao {
      margin-bottom: 10px;
      text-align: center;
      font-size: 11px;
      color: #bbb;
    }

    #lista-sismos {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 13px;
    }

    #lista-sismos li {
      padding: 6px 4px;
      border-bottom: 1px solid #333;
      cursor: pointer;
      display: flex;
      flex-direction: column;
    }

    #lista-sismos li:hover { background: #252525; }
    #lista-sismos li.active { background: #2f3b22; font-weight: 700; }

    #grafico-container {
      flex: 1;
      background: #000;
      position: relative;
    }

    #grafico {
      width: 100%;
      height: 100%;
    }

    .footer-global {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #000000cc;
      color: #ccc;
      text-align: center;
      padding: 6px 0;
      font-size: 12px;
      backdrop-filter: blur(4px);
      z-index: 9999;
    }

    #marca-logos {
      position: absolute;
      right: 20px;
      bottom: 65px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      opacity: 0.90;
      pointer-events: none;
      z-index: 50;
    }

    .marca-logo {
      height: 48px;
      width: auto;
      filter: drop-shadow(0 0 6px rgba(255,255,255,0.35));
      opacity: 0.95;
    }
  </style>
</head>

<body>

<div id="app">

  <div id="sidebar">

    <div style="text-align:center; margin-bottom:10px;">
      <img src="ipma-logo.png" style="height:40px; opacity:0.9;">
      <div style="font-size:11px; color:#bbb;">
        Dados sísmicos fornecidos pela Rede Sísmica Nacional – IPMA.pt
      </div>
    </div>

    <div style="text-align:center; margin-bottom:10px;">
      <img src="app-logo.png" style="height:70px; opacity:0.95;">
    </div>

    <h1>Sismos – Serra de Santa Bárbara</h1>
    <small>Últimos 30 dias • Raio 30 km • 3D local</small>

    <div id="ultima-atualizacao">Atualização: —</div>

    <ul id="lista-sismos">
      <li>Carregando dados do IPMA…</li>
    </ul>

    <div class="sidebar-footer">
      Fonte dos dados: <strong>IPMA.pt</strong><br>
      Sistema local: X/Y (km), Z (km – negativo abaixo da superfície)
    </div>

  </div>

  <div id="grafico-container">
    <div id="marca-logos">
      <img src="vost-portugal.png" class="marca-logo">
      <img src="VOSTAZ_f.png" class="marca-logo">
    </div>

    <div id="grafico"></div>
  </div>

</div>

<div class="footer-global">
  2025, Criado por Luís Serpa e melhorado por IA. Dados IPMA.PT. • 
  <a href="about.html">Sobre</a>
</div>

<script>
/* ============================================================
   FUNÇÕES NOVAS PARA INTERAÇÃO — PEDIDO DO LUÍS
   ============================================================ */

// NOVO — Variável global para guardar o gráfico Plotly
let graficoPlotly = null;

// NOVO — Centrar o gráfico num sismo clicado na lista
function focarSismoNoGrafico(index, quakes) {
  if (!graficoPlotly) return;

  const q = quakes.find(ev => ev.listIndex == index);
  if (!q) return;

  Plotly.animate(graficoPlotly, {
    layout: {
      scene: {
        camera: {
          eye: {
            x: q.x * 0.1,
            y: q.y * 0.1,
            z: 1.5
          }
        }
      }
    }
  }, {
    transition: { duration: 700 },
    frame: { duration: 700 }
  });

  destacarLista(index);
}

// NOVO — Fazer o ponto mais recente piscar
function piscarMaisRecente(quakes) {
  if (!graficoPlotly || !quakes.length) return;

  const idx = quakes[0].listIndex; // já está ordenado por mais recente

  let intensidade = 1;
  let direcao = -0.15;

  const intervalo = setInterval(() => {
    intensidade += direcao;

    if (intensidade <= 0.3) direcao = +0.15;
    if (intensidade >= 1.0) direcao = -0.15;

    Plotly.restyle(graficoPlotly, {
      "marker.opacity": [[
        ...quakes.map(q => q.listIndex === idx ? intensidade : 0.95)
      ]]
    }, [4]);

  }, 120);

  setTimeout(() => clearInterval(intervalo), 5000);
}

/* ============================================================
  (DESENHAR GRÁFICO)
   ============================================================ */

  const CENTER_LAT = 38.72972;
  const CENTER_LON = -27.31972;
  const RADIUS_KM  = 30;
  const PEAK_ALT_KM = 1.1;
  const API_URL = "https://api.ipma.pt/open-data/observation/seismic/3.json";

  function isSantaBarbara(region) {
    if (!region) return false;
    const r = region.toLowerCase();
    const palavras = [
      "serra sta. bárbara", "serra santa bárbara",
      "serra de santa bárbara", "sta. bárbara",
      "sta bárbara", "santa bárbara",
      "santa barbara", "sta barbara",
      "s. bárbara", "barbara"
    ];
    return palavras.some(p => r.includes(p));
  }

  function geoToXY(lat, lon) {
    const R = 6371;
    const dlat = (lat - CENTER_LAT) * Math.PI / 180;
    const dlon = (lon - CENTER_LON) * Math.PI / 180;
    const x = dlon * Math.cos(CENTER_LAT * Math.PI / 180) * R;
    const y = dlat * R;
    return { x, y };
  }

  function distanciaKm(lat, lon) {
    const { x, y } = geoToXY(lat, lon);
    return Math.sqrt(x*x + y*y);
  }

  function idadeNormalizada(date, minDate, maxDate) {
    const t = date.getTime();
    const t0 = minDate.getTime();
    const t1 = maxDate.getTime();
    return (t - t0) / (t1 - t0);
  }

  function corPorIdade(a) {
    const b = 1 - a;
    let r, g, bl;
    if (b < 0.5) {
      const frac = b / 0.5;
      r = Math.round(frac * 255);
      g = 255; bl = 0;
    } else {
      const frac = (b - 0.5) / 0.5;
      r = 255; g = Math.round(255 - frac * 255); bl = 0;
    }
    return `rgb(${r},${g},${bl})`;
  }
/* ============================================================
   ATIVAÇÃO DO CENÁRIO INTERATIVO
   ============================================================ */

async function carregar(){
  try{
    const resp = await fetch(API_URL);
    const json = await resp.json();
    const dados = json.data || [];

    const agora = new Date();
    const limite = new Date(agora.getTime() - 30*24*3600*1000);

    const eventos = [];
    let maisRecente = null;

    for(const e of dados){
      try{
        const t = new Date(e.time);
        if (isNaN(t) || t < limite) continue;

        const lat = +e.lat, lon = +e.lon, mag = +e.magnitud, depth = +e.depth;
        const region = e.obsRegion || "";

        if (!isSantaBarbara(region)) continue;
        const dist = distanciaKm(lat, lon);
        if (dist > RADIUS_KM) continue;

        const {x,y} = geoToXY(lat, lon);

        eventos.push({
          time: t,
          timeStr: t.toISOString().replace("T"," ").slice(0,16),
          lat, lon, mag, depth_km: depth, region, dist_km: dist, x, y
        });

        if (!maisRecente || t > maisRecente) maisRecente = t;

      }catch{}
    }

    if (!eventos.length){
      construirLista([]);
      desenharGrafico([]);
      document.getElementById("ultima-atualizacao").textContent =
        "Atualização: sem dados (IPMA)";
      return;
    }

    // Ordenação por antiguidade
    eventos.sort((a,b)=>a.time-b.time);
    const tMin = eventos[0].time;
    const tMax = eventos[eventos.length-1].time;

    eventos.forEach(ev => {
      ev.color = corPorIdade(idadeNormalizada(ev.time, tMin, tMax));
    });

    // Ordenação: mais recentes primeiro
    eventos.sort((a,b)=>b.time-a.time);
    eventos.forEach((ev,i)=>ev.listIndex = i);

    // Atualização info
    document.getElementById("ultima-atualizacao").textContent =
      `Atualização: ${maisRecente.toISOString().replace("T"," ").slice(0,16)} UTC`;

    // Lista e gráfico
    construirLista(eventos);
    desenharGrafico(eventos);

    // NOVO — Guardar handler do gráfico
    graficoPlotly = document.getElementById("grafico");

    // NOVO — Fazer o sismo mais recente piscar
    setTimeout(() => piscarMaisRecente(eventos), 800);

    // NOVO — Clique na lista para focar o sismo
    document.querySelectorAll("#lista-sismos li").forEach(li => {
      li.onclick = () => {
        const idx = parseInt(li.dataset.index);
        focarSismoNoGrafico(idx, eventos);
      };
    });

  }catch(err){
    console.error(err);
    document.getElementById("lista-sismos").innerHTML =
      "<li>Erro ao carregar dados do IPMA.</li>";
    document.getElementById("ultima-atualizacao").textContent =
      "Atualização: erro ao contactar IPMA";
  }
}

carregar();

/* ============================================================
   SERVICE WORKER
   ============================================================ */
if("serviceWorker" in navigator){
  window.addEventListener("load",()=>{
    navigator.serviceWorker.register("service-worker.js")
      .catch(err=>console.warn("SW falhou:",err));
  });
}

